<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LOOM Transformer Example</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        max-width: 800px;
        margin: 40px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        margin-top: 0;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
      }
      .error {
        background: #ffebee;
        border-left-color: #f44336;
      }
      .success {
        background: #e8f5e9;
        border-left-color: #4caf50;
      }
      button {
        background: #2196f3;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin-right: 10px;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      button:hover:not(:disabled) {
        background: #1976d2;
      }
      textarea {
        width: 100%;
        min-height: 80px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: inherit;
        font-size: 14px;
        margin: 10px 0;
      }
      .output {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 4px;
        min-height: 100px;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: "Courier New", monospace;
        margin: 10px 0;
      }
      .controls {
        display: flex;
        gap: 10px;
        align-items: center;
        margin: 20px 0;
      }
      label {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      input[type="number"] {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 80px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸ¤– LOOM Transformer Example</h1>

      <div id="status" class="status">
        Loading WASM and initializing transformer...
      </div>

      <div style="margin: 20px 0">
        <h3>Generate Text</h3>
        <textarea id="prompt" placeholder="Enter your prompt here...">
The capital of France is</textarea
        >

        <div class="controls">
          <label>
            Max Tokens:
            <input type="number" id="maxTokens" value="50" min="1" max="500" />
          </label>
          <label>
            Temperature:
            <input
              type="number"
              id="temperature"
              value="0.7"
              min="0"
              max="2"
              step="0.1"
            />
          </label>
          <button id="generateBtn" onclick="generateText()">Generate</button>
          <button id="streamBtn" onclick="streamText()">Stream</button>
        </div>

        <h4>Output:</h4>
        <div id="output" class="output">Generated text will appear here...</div>
      </div>
    </div>

    <script type="module">
      import { initLoom, createTransformerAPI } from "../dist/index.js";

      let transformer = null;
      const statusEl = document.getElementById("status");
      const outputEl = document.getElementById("output");
      const generateBtn = document.getElementById("generateBtn");
      const streamBtn = document.getElementById("streamBtn");

      function setStatus(message, type = "info") {
        statusEl.textContent = message;
        statusEl.className = "status";
        if (type === "error") statusEl.classList.add("error");
        if (type === "success") statusEl.classList.add("success");
      }

      async function initialize() {
        try {
          setStatus("Initializing WASM...");
          await initLoom();

          setStatus("Creating transformer API...");
          transformer = await createTransformerAPI();

          setStatus("Loading tokenizer...");
          const tokenizerResp = await fetch(
            "../../models/SmolLM2-135M-Instruct/tokenizer.json"
          );
          if (!tokenizerResp.ok) {
            throw new Error(
              `Failed to load tokenizer: ${tokenizerResp.status}`
            );
          }
          const tokenizerData = new Uint8Array(
            await tokenizerResp.arrayBuffer()
          );
          const tokResult = await transformer.loadTokenizer(tokenizerData);

          if (!tokResult.success) throw new Error(tokResult.error);

          setStatus("Loading model (this may take a moment)...");
          const configResp = await fetch(
            "../../models/SmolLM2-135M-Instruct/config.json"
          );
          if (!configResp.ok) {
            throw new Error(`Failed to load config: ${configResp.status}`);
          }
          const weightsResp = await fetch(
            "../../models/SmolLM2-135M-Instruct/model.safetensors"
          );
          if (!weightsResp.ok) {
            throw new Error(`Failed to load weights: ${weightsResp.status}`);
          }

          const configData = new Uint8Array(await configResp.arrayBuffer());
          const weightsData = new Uint8Array(await weightsResp.arrayBuffer());

          console.log("Config size:", configData.length);
          console.log("Weights size:", weightsData.length);

          const modelResult = await transformer.loadModel(
            configData,
            weightsData
          );

          console.log("Model result:", modelResult);

          if (!modelResult.success) {
            throw new Error(
              modelResult.error || modelResult.message || "Failed to load model"
            );
          }

          setStatus(
            `âœ“ Ready! Model: ${modelResult.num_layers} layers, ${modelResult.hidden_size} hidden size`,
            "success"
          );

          generateBtn.disabled = false;
          streamBtn.disabled = false;
        } catch (error) {
          console.error("Full error object:", error);
          const errorMsg =
            error.message || error.error || String(error) || "Unknown error";
          setStatus(`Error: ${errorMsg}`, "error");
          console.error(error);
        }
      }

      window.generateText = async function () {
        if (!transformer) return;

        const prompt = document.getElementById("prompt").value;
        const maxTokens = parseInt(document.getElementById("maxTokens").value);
        const temperature = parseFloat(
          document.getElementById("temperature").value
        );

        try {
          generateBtn.disabled = true;
          streamBtn.disabled = true;
          setStatus("Generating...");
          outputEl.textContent = "Generating...";

          const result = await transformer.generate(
            prompt,
            maxTokens,
            temperature
          );

          if (!result.success) throw new Error(result.error);

          outputEl.textContent = result.generated_text;
          setStatus("âœ“ Generation complete", "success");
        } catch (error) {
          setStatus(`Error: ${error.message}`, "error");
          outputEl.textContent = `Error: ${error.message}`;
        } finally {
          generateBtn.disabled = false;
          streamBtn.disabled = false;
        }
      };

      window.streamText = async function () {
        if (!transformer) return;

        const prompt = document.getElementById("prompt").value;
        const maxTokens = parseInt(document.getElementById("maxTokens").value);
        const temperature = parseFloat(
          document.getElementById("temperature").value
        );

        try {
          generateBtn.disabled = true;
          streamBtn.disabled = true;
          setStatus("Streaming...");
          outputEl.textContent = "";

          let tokenCount = 0;
          for await (const token of transformer.generateStream(
            prompt,
            maxTokens,
            temperature
          )) {
            outputEl.textContent += token;
            tokenCount++;
          }

          setStatus(`âœ“ Generated ${tokenCount} tokens`, "success");
        } catch (error) {
          setStatus(`Error: ${error.message}`, "error");
          outputEl.textContent += `\n\nError: ${error.message}`;
        } finally {
          generateBtn.disabled = false;
          streamBtn.disabled = false;
        }
      };

      // Initialize on load
      initialize();
    </script>
  </body>
</html>
