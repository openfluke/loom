<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  
  <PropertyGroup>
    <WelvetNativeLibPath>$(MSBuildThisFileDirectory)..\runtimes\</WelvetNativeLibPath>
  </PropertyGroup>
  
  <!-- Detect architecture for choosing correct native library -->
  <PropertyGroup>
    <WelvetIsArm64 Condition="'$(RuntimeIdentifier)' != '' And ($(RuntimeIdentifier.Contains('arm64')) Or $(RuntimeIdentifier.Contains('aarch64')))">true</WelvetIsArm64>
    <WelvetIsArm64 Condition="'$(WelvetIsArm64)' == '' And '$([System.Runtime.InteropServices.RuntimeInformation]::ProcessArchitecture)' == 'Arm64'">true</WelvetIsArm64>
  </PropertyGroup>

  <ItemGroup>
    <!-- Windows x64 -->
    <None Include="$(WelvetNativeLibPath)windows_x86_64\libloom.dll" 
          Condition="('$(OS)' == 'Windows_NT' Or '$(TargetPlatformIdentifier)' == 'Windows') And '$(WelvetIsArm64)' != 'true'">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>libloom.dll</Link>
      <Visible>false</Visible>
    </None>
    
    <!-- Windows ARM64 -->
    <None Include="$(WelvetNativeLibPath)windows_arm64\libloom.dll" 
          Condition="('$(OS)' == 'Windows_NT' Or '$(TargetPlatformIdentifier)' == 'Windows') And '$(WelvetIsArm64)' == 'true'">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>libloom.dll</Link>
      <Visible>false</Visible>
    </None>
    
    <!-- Linux x64 (non-Android) -->
    <None Include="$(WelvetNativeLibPath)linux_x86_64\libloom.so" 
          Condition="'$(OS)' != 'Windows_NT' And '$(TargetFrameworkIdentifier)' != 'MonoAndroid' And '$(TargetPlatformIdentifier)' != 'android' And '$(TargetPlatformIdentifier)' != 'macOS' And '$(TargetPlatformIdentifier)' != 'maccatalyst' And '$(WelvetIsArm64)' != 'true'">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>libloom.so</Link>
      <Visible>false</Visible>
    </None>
    
    <!-- Linux ARM64 (non-Android) -->
    <None Include="$(WelvetNativeLibPath)linux_arm64\libloom.so" 
          Condition="'$(OS)' != 'Windows_NT' And '$(TargetFrameworkIdentifier)' != 'MonoAndroid' And '$(TargetPlatformIdentifier)' != 'android' And '$(TargetPlatformIdentifier)' != 'macOS' And '$(TargetPlatformIdentifier)' != 'maccatalyst' And '$(WelvetIsArm64)' == 'true'">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>libloom.so</Link>
      <Visible>false</Visible>
    </None>
    
    <!-- macOS (using universal by default for broad compatibility) -->
    <None Include="$(WelvetNativeLibPath)macos_universal\libloom.dylib" 
          Condition="'$(TargetPlatformIdentifier)' == 'macOS' Or '$(TargetPlatformIdentifier)' == 'maccatalyst'">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>libloom.dylib</Link>
      <Visible>false</Visible>
    </None>
    
    <!-- Android -->
    <None Include="$(WelvetNativeLibPath)android_arm64\libloom.so" 
          Condition="'$(TargetFrameworkIdentifier)' == 'MonoAndroid' Or '$(TargetPlatformIdentifier)' == 'android'">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>libloom.so</Link>
      <Visible>false</Visible>
    </None>
  </ItemGroup>

  <!-- MAUI-specific: Also add as AndroidNativeLibrary for Android -->
  <ItemGroup Condition="'$(TargetFrameworkIdentifier)' == 'MonoAndroid' Or '$(TargetPlatformIdentifier)' == 'android'">
    <AndroidNativeLibrary Include="$(WelvetNativeLibPath)android_arm64\libloom.so">
      <Link>libs\arm64-v8a\libloom.so</Link>
    </AndroidNativeLibrary>
  </ItemGroup>

  <!-- iOS: Use NativeReference for static libraries -->
  <!-- iOS Device (arm64) -->
  <ItemGroup Condition="'$(TargetPlatformIdentifier)' == 'iOS' And '$(RuntimeIdentifier)' == 'ios-arm64'">
    <NativeReference Include="$(WelvetNativeLibPath)ios_arm64\libloom.a">
      <Kind>Static</Kind>
      <ForceLoad>true</ForceLoad>
    </NativeReference>
  </ItemGroup>

  <!-- iOS Simulator ARM64 -->
  <ItemGroup Condition="'$(TargetPlatformIdentifier)' == 'iOS' And '$(RuntimeIdentifier)' == 'iossimulator-arm64'">
    <NativeReference Include="$(WelvetNativeLibPath)ios_arm64_sim\libloom.a">
      <Kind>Static</Kind>
      <ForceLoad>true</ForceLoad>
    </NativeReference>
  </ItemGroup>

  <!-- iOS Simulator x64 -->
  <ItemGroup Condition="'$(TargetPlatformIdentifier)' == 'iOS' And '$(RuntimeIdentifier)' == 'iossimulator-x64'">
    <NativeReference Include="$(WelvetNativeLibPath)ios_x86_64_sim\libloom.a">
      <Kind>Static</Kind>
      <ForceLoad>true</ForceLoad>
    </NativeReference>
  </ItemGroup>

  <!-- MAUI Windows: Ensure DLL is in the app bundle -->
  <Target Name="WelvetCopyWindowsNative" 
          AfterTargets="Build" 
          Condition="('$(TargetPlatformIdentifier)' == 'Windows' Or '$(OS)' == 'Windows_NT') And Exists('$(WelvetNativeLibPath)windows_x86_64\libloom.dll')">
    <Copy SourceFiles="$(WelvetNativeLibPath)windows_x86_64\libloom.dll" 
          DestinationFiles="$(OutputPath)libloom.dll" 
          SkipUnchangedFiles="true" />
    <Message Importance="high" Text="Welvet: Copied libloom.dll to $(OutputPath)" />
  </Target>

  <!-- MAUI: Force Welvet.dll to be copied to output (MAUI sometimes skips it) -->
  <Target Name="WelvetCopyManagedAssembly" 
          AfterTargets="Build"
          Condition="'$(TargetPlatformIdentifier)' == 'Windows' Or '$(TargetPlatformIdentifier)' == 'android' Or '$(TargetPlatformIdentifier)' == 'macOS' Or '$(TargetPlatformIdentifier)' == 'maccatalyst'">
    <PropertyGroup>
      <WelvetManagedDllPath>$(MSBuildThisFileDirectory)..\lib\net9.0\Welvet.dll</WelvetManagedDllPath>
    </PropertyGroup>
    <Copy SourceFiles="$(WelvetManagedDllPath)" 
          DestinationFiles="$(OutputPath)Welvet.dll" 
          SkipUnchangedFiles="true"
          Condition="Exists('$(WelvetManagedDllPath)')" />
    <Message Importance="high" Text="Welvet: Copied Welvet.dll to $(OutputPath)" Condition="Exists('$(WelvetManagedDllPath)')" />
    <Warning Text="Welvet: Could not find Welvet.dll at $(WelvetManagedDllPath)" Condition="!Exists('$(WelvetManagedDllPath)')" />
  </Target>
  
  <!-- Debug output to help troubleshoot -->
  <Target Name="WelvetDebugInfo" BeforeTargets="BeforeBuild">
    <Message Importance="high" Text="=== Welvet Native Library Configuration ===" />
    <Message Importance="high" Text="Welvet: OS = $(OS)" />
    <Message Importance="high" Text="Welvet: TargetFrameworkIdentifier = $(TargetFrameworkIdentifier)" />
    <Message Importance="high" Text="Welvet: TargetPlatformIdentifier = $(TargetPlatformIdentifier)" />
    <Message Importance="high" Text="Welvet: RuntimeIdentifier = $(RuntimeIdentifier)" />
    <Message Importance="high" Text="Welvet: OutputPath = $(OutputPath)" />
    <Message Importance="high" Text="Welvet: Native lib path = $(WelvetNativeLibPath)" />
    <Message Importance="high" Text="==========================================" />
  </Target>
  
</Project>
